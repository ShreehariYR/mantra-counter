<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üïâÔ∏è Mantra Mala Counter</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body {
    font-family: Arial, sans-serif;
    text-align: center;
    background: #f4f4f4;
    padding: 15px;
  }

  h1 { margin-bottom: 5px; }

  #count {
    font-size: 48px;
    color: green;
    margin: 10px 0;
  }

  select, input, button {
    padding: 10px;
    font-size: 16px;
    margin: 5px;
    width: 90%;
    max-width: 300px;
  }

  #beads {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 6px;
    max-width: 360px;
    margin: 20px auto;
  }

  .bead {
    width: 22px;
    height: 22px;
    border-radius: 50%;
    background: #ccc;
  }

  .bead.active {
    background: orange;
    box-shadow: 0 0 6px orange;
  }

  #status {
    margin-top: 10px;
    font-weight: bold;
  }
</style>
</head>

<body>

<h1>üïâÔ∏è Mantra Mala Counter</h1>
<p>Ram Naam / Any Mantra</p>

<div id="count">0</div>

<select id="goalSelect">
  <option value="108">108 (1 Mala)</option>
  <option value="1008">1008</option>
  <option value="custom">Custom</option>
</select>

<input type="number" id="customGoal" placeholder="Enter custom goal" style="display:none">

<button onclick="start()">‚ñ∂ Start Chanting</button>
<button onclick="stop()">‚èπ Stop</button>
<button onclick="resetToday()">üîÅ Reset Today</button>

<div id="beads"></div>

<div id="status"></div>

<!-- Shankh sound -->
<audio id="shankh">
  <source src="https://upload.wikimedia.org/wikipedia/commons/4/4f/Shankha_conch_sound.ogg" type="audio/ogg">
</audio>

<script>
let audioContext, analyser, mic, dataArray;
let listening = false;
let lastSoundTime = 0;

const today = new Date().toISOString().split("T")[0];
let data = JSON.parse(localStorage.getItem("mantraData")) || {};

if (!data[today]) data[today] = { count: 0, goal: 108 };

const countEl = document.getElementById("count");
const beadsEl = document.getElementById("beads");
const statusEl = document.getElementById("status");
const shankh = document.getElementById("shankh");

countEl.innerText = data[today].count;

// ---------------- BEADS ----------------
function drawBeads() {
  beadsEl.innerHTML = "";
  let beadsToShow = Math.min(data[today].goal, 108);
  for (let i = 0; i < beadsToShow; i++) {
    const bead = document.createElement("div");
    bead.className = "bead";
    if (i < data[today].count % beadsToShow) bead.classList.add("active");
    beadsEl.appendChild(bead);
  }
}

drawBeads();

// ---------------- GOAL ----------------
goalSelect.onchange = () => {
  if (goalSelect.value === "custom") {
    customGoal.style.display = "block";
    customGoal.onchange = () => {
      data[today].goal = parseInt(customGoal.value);
      save();
      drawBeads();
    };
  } else {
    customGoal.style.display = "none";
    data[today].goal = parseInt(goalSelect.value);
    save();
    drawBeads();
  }
};

// ---------------- AUDIO ----------------
async function start() {
  audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
  mic = audioContext.createMediaStreamSource(stream);

  analyser = audioContext.createAnalyser();
  analyser.fftSize = 512;
  mic.connect(analyser);

  dataArray = new Uint8Array(analyser.frequencyBinCount);
  listening = true;
  statusEl.innerText = "Listening...";
  detect();
}

function detect() {
  if (!listening) return;

  analyser.getByteFrequencyData(dataArray);
  let volume = dataArray.reduce((a, b) => a + b) / dataArray.length;
  let now = Date.now();

  // üî• Adaptive fast chanting detection
  if (volume > 30 && now - lastSoundTime > 300) {
    data[today].count++;
    lastSoundTime = now;
    countEl.innerText = data[today].count;
    save();
    drawBeads();

    if (data[today].count === data[today].goal) {
      shankh.play();
      alert("üôè Goal Completed");
      stop();
      return;
    }
  }

  requestAnimationFrame(detect);
}

function stop() {
  listening = false;
  if (audioContext) audioContext.close();
  statusEl.innerText = "Stopped";
}

function resetToday() {
  if (confirm("Reset today's count?")) {
    data[today].count = 0;
    countEl.innerText = 0;
    save();
    drawBeads();
  }
}

function save() {
  localStorage.setItem("mantraData", JSON.stringify(data));
}
</script>

</body>
</html>
